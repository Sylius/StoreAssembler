#!/usr/bin/env bash
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

if [ "$#" -ne 1 ]; then
  echo -e "${YELLOW}Usage: $0 <preset-name>${NC}"
  exit 1
fi

PRESET_NAME="$1"

REPO="Sylius/StorePreset"
BRANCH="main"
TARGET_DIR="store-presets"
OUTPUT_DIR="store-preset"
ZIP_URL="https://github.com/$REPO/archive/refs/heads/$BRANCH.zip"

TMP_DIR=$(mktemp -d)
ZIP_FILE="$TMP_DIR/archive.zip"

echo -e "${BLUE}Downloading $REPO#$BRANCH â†’ $TARGET_DIR/${NC}"
curl -L "$ZIP_URL" -o "$ZIP_FILE"

echo -e "${BLUE}Extracting archive...${NC}"
unzip -q "$ZIP_FILE" -d "$TMP_DIR"

EXTRACTED_DIR="$TMP_DIR/$(basename "$REPO")-$BRANCH"

echo -e "${BLUE}Cleaning any existing $OUTPUT_DIR directory...${NC}"
rm -rf "$OUTPUT_DIR"

if [ ! -d "$EXTRACTED_DIR/$TARGET_DIR/$PRESET_NAME" ]; then
  echo -e "${RED}Error: preset '$PRESET_NAME' not found in $REPO/$TARGET_DIR.${NC}" >&2
  echo -e "${YELLOW}Available presets:${NC}" >&2
  for d in "$EXTRACTED_DIR/$TARGET_DIR"/*; do
    if [ -d "$d" ]; then
      echo -e "  - ${YELLOW}$(basename "$d")${NC}" >&2
    fi
  done
  exit 1
fi

echo -e "${GREEN}Moving preset '$PRESET_NAME' to $OUTPUT_DIR...${NC}"
mv "$EXTRACTED_DIR/$TARGET_DIR/$PRESET_NAME" "$OUTPUT_DIR"

echo -e "${BLUE}Removing temporary files...${NC}"
rm -rf "$TMP_DIR"

echo -e "${GREEN}Done!${NC}"
